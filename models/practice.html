<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition Attendance</title>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCGiBeeTdmkRvjSXnjrmZp091w055lThMI",
            authDomain: "autopresence-b9594.firebaseapp.com",
            projectId: "autopresence-b9594",
            storageBucket: "autopresence-b9594.firebasestorage.app",
            messagingSenderId: "139292140260",
            appId: "1:139292140260:web:664258705e59f7ce7782f1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.onload = async () => {
            if (typeof faceapi === "undefined") {
                document.getElementById('status').innerText = "âŒ face-api.js failed to load!";
                return;
            }

            try {
                await faceapi.nets.ssdMobilenetv1.loadFromUri('./');
                await faceapi.nets.faceRecognitionNet.loadFromUri('./');
                await faceapi.nets.faceLandmark68Net.loadFromUri('./');
                document.getElementById('status').innerText = "âœ… Model Loaded! Click Start to begin attendance.";
                await loadStoredFaces();
            } catch (error) {
                document.getElementById('status').innerText = "âŒ Error loading models!";
                console.error("Model loading error:", error);
            }
        };

        const video = document.getElementById('video');
        const MATCH_THRESHOLD = 0.5;
        let labeledDescriptors = [];
        let attendanceMarked = false;

        async function loadStoredFaces() {
            const persons = {
                "Manasvi Trivedi": ["Manasvi1.jpg", "Manasvi2.jpg", "Manasvi3.jpg","Manasvi4.jpg","Manasvi5.jpg","Manasvi6.jpg","Manasvi7.jpg","Manasvi8.jpg","Manasvi9.jpg","Manasvi10.jpg","Manasvi11.jpg","Manasvi12.jpg","Manasvi13.jpg","Manasvi14.jpg","Manasvi15.jpg","Manasvi16.jpg","Manasvi17.jpg","Manasvi18.jpg","Manasvi19.jpg","Manasvi20.jpg"],
                "Aayushi Soni": ["Aayushi1.jpg", "Aayushi2.jpg", "Aayushi3.jpg", "Aayushi4.jpg", "Aayushi5.jpg", "Aayushi6.jpg","Aayushi7.jpg","Aayushi8.jpg","Aayushi9.jpg","Aayushi10.jpg","Aayushi11.jpg","Aayushi12.jpg","Aayushi13.jpg","Aayushi14.jpg","Aayushi15.jpg","Aayushi16.jpg","Aayushi17.jpg","Aayushi18.jpg","Aayushi19.jpg","Aayushi20.jpg","Aayushi21.jpg","Aayushi22.jpg","Aayushi23.jpg","Aayushi24.jpg"],
                "Hetvi Suthar": ["Hetvi1.jpg","Hetvi2.jpg","Hetvi3.jpg","Hetvi4.jpg","Hetvi5.jpg","Hetvi6.jpg","Hetvi7.jpg","Hetvi8.jpg","Hetvi9.jpg","Hetvi10.jpg","Hetvi11.jpg","Hetvi12.jpg","Hetvi13.jpg","Hetvi14.jpg"],
                "Kaavyaa Sagar": ["Kaavyaa1.jpg","Kaavyaa2.jpg","Kaavyaa3.jpg","Kaavyaa4.jpg","Kaavyaa5.jpg","Kaavyaa6.jpg","Kaavyaa7.jpg","Kaavyaa8.jpg","Kaavyaa9.jpg","Kaavyaa10.jpg","Kaavyaa11.jpg","Kaavyaa12.jpg","Kaavyaa13.jpg","Kaavyaa14.jpg"],
                "Krisha Kharva": ["Krisha1.jpg","Krisha2.jpg","Krisha3.jpg","Krisha4.jpg","Krisha5.jpg","Krisha6.jpg","Krisha7.jpg","Krisha8.jpg","Krisha9.jpg","Krisha10.jpg","Krisha11.jpg"],
                "Tisa Raval": ["Tisha1.jpg","Tisha2.jpg","Tisha3.jpg","Tisha4.jpg","Tisha5.jpg","Tisha6.jpg","Tisha7.jpg","Tisha8.jpg","Tisha9.jpg","Tisha10.jpg"],
                "Aeshaben Patel":["Aesha1.jpg","Aesha2.jpg","Aesha3.jpg","Aesha4.jpg","Aesha5.jpg","Aesha6.jpg","Aesha7.jpg","Aesha8.jpg","Aesha9.jpg","Aesha10.jpg","Aesha11.jpg","Aesha12.jpg","Aesha13.jpg","Aesha14.jpg"],
                "Anirudh Rathod":["Anirudh1.jpg","Anirudh2.jpg","Anirudh3.jpg","Anirudh4.jpg","Anirudh5.jpg","Anirudh6.jpg","Anirudh7.jpg","Anirudh8.jpg","Anirudh9.jpg","Anirudh10.jpg","Anirudh11.jpg","Anirudh12.jpg","Anirudh13.jpg","Anirudh14.jpg","Anirudh15.jpg","Anirudh16.jpg","Anirudh17.jpg","Anirudh18.jpg","Anirudh19.jpg","Anirudh20.jpg","Anirudh21.jpg","Anirudh22.jpg","Anirudh23.jpg","Anirudh24.jpg"],
                "Himani Prajapati":["Himani1.jpg","Himani2.jpg","Himani3.jpg","Himani4.jpg","Himani5.jpg","Himani6.jpg","Himani7.jpg","Himani8.jpg","Himani9.jpg","Himani10.jpg","Himani11.jpg","Himani12.jpg","Himani13.jpg"],
                "Hitarth Thombre":["Hitarth1.jpg","Hitarth2.jpg","Hitarth3.jpg","Hitarth4.jpg","Hitarth5.jpg","Hitarth6.jpg","Hitarth7.jpg","Hitarth8.jpg","Hitarth9.jpg"],
                "Rudra Parmar":["Rudra1.jpg","Rudra2.jpg","Rudra3.jpg","Rudra4.jpg","Rudra5.jpg","Rudra6.jpg"],
                "Tirth Gandhi":["Tirth1.jpg","Tirth2.jpg","Tirth3.jpg","Tirth4.jpg","Tirth5.jpg","Tirth6.jpg","Tirth7.jpg","Tirth8.jpg"],
                "Vikas Rajput":["Vikas1.jpg","Vikas2.jpg","Vikas3.jpg"]
            };
            for (const [name, images] of Object.entries(persons)) {
                const descriptors = [];
                for (const img of images) {
                    try {
                        const image = await faceapi.fetchImage(`./stored_faces/${img}`);
                        const detection = await faceapi.detectSingleFace(image).withFaceLandmarks().withFaceDescriptor();
                        if (detection) {
                            descriptors.push(detection.descriptor);
                        } else {
                            console.warn(`âš ï¸ No face detected in ${img}`);
                        }
                    } catch (error) {
                        console.error(`ðŸš¨ Error loading image ${img}:`, error);
                    }
                }
                if (descriptors.length > 0) {
                    labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(name, descriptors));
                } else {
                    console.warn(`âš ï¸ No valid descriptors found for ${name}`);
                }
            }
            if (labeledDescriptors.length === 0) {
                console.error("ðŸš¨ No stored faces found! Face recognition will not work.");
            } else {
                console.log("âœ… Stored faces loaded successfully!");
                document.getElementById('status').innerText = "âœ… Stored faces loaded!";
            }
        }

        function getCurrentLecture() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const lectureTimes = [
            { start: "20:10", end: "21:10", name: "Ai" },
            { start: "17:15", end: "20:20", name: "Ns" },
            { start: "21:21", end: "21:30", name: "Mad" },
            { start: "21:31", end: "22:30", name: "MP" },
            { start: "12:20", end: "13:30", name: "Ai" }
        ];
            for (let { start, end, name } of lectureTimes) {
                const [startHour, startMinute] = start.split(":").map(Number);
                const [endHour, endMinute] = end.split(":").map(Number);
                if (currentTime >= startHour * 60 + startMinute && currentTime <= endHour * 60 + endMinute) return name;
            }
            return null;
        }

        window.startVideo = async function () {
            const lectureName = getCurrentLecture();
            if (!lectureName) {
                document.getElementById('status').innerText = "âŒ Attendance only during lecture hours!";
                return;
            }
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            video.onloadeddata = () => detectFace(lectureName);
        }

        async function detectFace(lectureName) {
            if (attendanceMarked || labeledDescriptors.length === 0) return;

            const detections = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();
            if (detections) {
                const detectedDescriptor = detections.descriptor;
                const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, MATCH_THRESHOLD);
                const bestMatch = faceMatcher.findBestMatch(detectedDescriptor);

                if (bestMatch.label !== "unknown") {
                    const confirmAttendance = confirm(`Do you want to mark attendance for ${bestMatch.label}?`);
                    if (confirmAttendance) {
                        document.getElementById('status').innerText = `âœ… Attendance Marked for ${bestMatch.label}!`;
                        await storeFaceMatchResult(bestMatch.label, lectureName);
                        attendanceMarked = true;
                        stopVideo();
                    } else {
                        document.getElementById('status').innerText = "âŒ Attendance not marked. Rescanning...";
                        setTimeout(() => detectFace(lectureName), 100);
                    }
                } else {
                    document.getElementById('status').innerText = "âŒ Face detected, but not recognized!";
                }
            }
            if (!attendanceMarked) setTimeout(() => detectFace(lectureName), 100);
        }
        async function storeAttendance() {
            try {
                await addDoc(collection(db, "face_recognition_results"), { timestamp: new Date() });
                setTimeout(() => {
                    window.location.href = "../camera_microphone.html";
                }, 2000);
            } catch (error) {
                console.error('Error storing attendance:', error);
            }
        }
        async function storeFaceMatchResult(name, lectureName) {
            try {
                const timestamp = new Date();
                const lectureDetails = {
                    timestamp: timestamp.toISOString(),
                    lectureName: lectureName,
                    studentName: name
                };
                await addDoc(collection(db, "face_recognition_results"), lectureDetails);
                console.log(`âœ… Attendance stored in Firebase for ${name} in ${lectureName}`);

                document.getElementById('status').innerText = `âœ… Attendance marked successfully for ${name}! Redirecting...`;

                setTimeout(() => {
                    window.location.href = "../camera_microphone.html";
                }, 2000);

            } catch (error) {
                console.error('ðŸš¨ Error storing attendance in Firebase:', error);
            }
        }

        function stopVideo() {
            let stream = video.srcObject;
            if (stream) stream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #001f3f;
            color: white;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 400px;
        }
        h1 { color: #001f3f; }
        button {
            margin-top: 15px;
            padding: 10px;
            background: #004e92;
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Face Recognition Attendance</h1>
        <video id="video" width="320" height="240" autoplay muted></video>
        <div id="status">Loading model...</div>
        <button onclick="startVideo()">Open Camera</button>
    </div>
</body>
</html>
